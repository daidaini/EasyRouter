# 汇点网关前置路由

## 程序目的
部署在汇点交易网关之前，可以通过登录报文中的某一些信息（或者仅仅套接字信息），可以判断当前的连接应该属于哪个服务。  
包括区分不同柜台的不同网关服务，或者是同一个网关服务的不同类型服务，或者根据某些规则完成类似负载均衡的作用。  

## 客户需求场景
1. 光大证券，需要经过某个三方系统确认当前登录的账号属于哪个柜台（恒生T3的还是金仕达的），确认好柜台后，将该连接的数据转到对应的网关上。  
2. 国泰君安证券，需要通过登录中的交易节点字段来进行分发到不同柜台的网关（金证KCBP、泰琰）
3. 中信证券，需要从恒生柜台获取到当前账号的节点标识，确认需要连恒生还是顶点


## 框架确认
1. 最重要的功能是转发，所以一定需要注意资源的消耗以及处理的速度
2. 网络框架是延用muduo，还是尝试使用boost.asio?  
    使用muduo确保代码一致性，以及维护上的可行性


3. 怎么跟网关交互，使用muduo的TcpClient.  
    - 先设定为 一个地址一个EventLoop，同一个地址的client复用一个loop。初始化时，在地址确定后就可以确定创建多少个Eventloop

4. 线程资源的管理
    - 需不需要使用一个用户一个分发线程？  
    - Server本身可以有线程池去处理收到的数据，直接在线程池中，创建TcpClient并进行实时数据的转发，是否效率更高？
    

5. 跟第三方的认证，可以交付到单独的线程去同步处理。
    - 可以使用一个线程池，专门处理第三方的认证
    - 同步认证成功，确定路由目标，然后创建TcpClient，并进行client的连接，这些都在认证线程池中进行。
    - client和客户端连接的管理，必然是全局管理，因此在线程池中也能操作（前提是需要将客户端连接信息传入线程）

6. 线程数量统计
    - 主线程，可以负责服务EventLoop的loop循环.  (1) (HDGwRouter)
    - TcpServer内部的threadpool，可以外部设置进去.(4-32) (RouterServer)
    - 跟网关交互的Eventloop的线程. (2-4)  (LoopThread)
    - 三方认证线程池,，可以外部设置进去 (4-32) (AskingThread)
    - 日志线程，可以负责服务EventLoop的loop循环.  (2) (HDGwRouter)

7. 全局资源归纳
    - 目标交易网关地址信息
    - TcpServer的eventloop
    - 转发目标网关的eventloop
    - 客户连接信息跟connid 的关联

8. 用户断开的处理
    - 客户端主动断开，则需要srcConn 通知 dstClient 关闭
    - 网关主动断开，则需要dstClinet 通知 SrcConn关闭
    
9. 路由服务推送的密钥信息的格式设计
    - 设置头标识，以便于交易网关端解析
    - 两个密钥随机串
    - 各数据之间使用逗号分隔
    格式设计如下：
    ```
    Router,commkey_abc,pwdkey_123,
    ```

10. 跟网关之间的交互流程
    a. 在获取到客户端的连接成功之后，就创建跟网关交互的client资源。  因为，我们需要client管理缓存相关的密钥信息
    b. 在根据客户端的登录报文获取到路由标识之后，再使用client创建跟交易网关的连接。  
    c. 在网关连接成功的响应中，进行推送密钥，发送登录报文等操作

11. IP溯源的问题
    需要做到，在推送密钥的时候，将对端IP也推送过去，那么，推送的数据则变成了：
    ```
    Router,commkey_abc,pwdkey_123,peer_addr_ip,
    ```
12. 支持全切的时候的配置项的热更新
    确定使用哪个配置项作为对是否回切的开关，并支持热更新  
    是否可以单独使用一个配置文件(backcut.ini)，当有这个文件的时候再定时检查它的内容；  
    内容可以设置，参考如下格式:
    ```txt
    [global]
    1 = DDA5,HST2
    ;标识DDA5全局回切到HST2柜台
    2 = HTS,DDA5
    ;标识HTS全局回切到DDA5柜台
    ```
    这样配置，其实一般只需要一个，  且一旦配置了就认为需要回切对应柜台


13. 站点的配置项需要支持交易类别，是期权还是股票  
    





