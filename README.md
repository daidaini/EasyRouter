# 汇点网关前置路由

## 程序目的
部署在汇点交易网关之前，可以通过登录报文中的某一些信息（或者仅仅套接字信息），可以判断当前的连接应该属于哪个服务。  
包括区分不同柜台的不同网关服务，或者是同一个网关服务的不同类型服务，或者根据某些规则完成类似负载均衡的作用。  

## 客户需求场景
1. 光大证券，需要经过某个三方系统确认当前登录的账号属于哪个柜台（恒生T3的还是金仕达的），确认好柜台后，将该连接的数据转到对应的网关上。  
2. 国泰君安证券，需要通过登录中的交易节点字段来进行分发到不同柜台的网关（金证KCBP、泰琰）
3. 中信证券，需要从恒生柜台获取到当前账号的节点标识，确认需要连恒生还是顶点


## 框架确认
1. 最重要的功能是转发，所以一定需要注意资源的消耗以及处理的速度
2. 网络框架是延用muduo，还是尝试使用boost.asio?  
    使用muduo确保代码一致性，以及维护上的可行性


3. 怎么跟网关交互，使用muduo的TcpClient.  
    - 先设定为 一个地址一个EventLoop，同一个地址的client复用一个loop。初始化时，在地址确定后就可以确定创建多少个Eventloop

4. 线程资源的管理
    - 需不需要使用一个用户一个分发线程？  
    - Server本身可以有线程池去处理收到的数据，直接在线程池中，创建TcpClient并进行实时数据的转发，是否效率更高？
    

5. 跟第三方的认证，可以交付到单独的线程去同步处理。
    - 可以使用一个线程池，专门处理第三方的认证
    - 同步认证成功，确定路由目标，然后创建TcpClient，并进行client的连接，这些都在认证线程池中进行。
    - client和客户端连接的管理，必然是全局管理，因此在线程池中也能操作（前提是需要将客户端连接信息传入线程）

6. 线程数量统计
    - 主线程，可以负责服务EventLoop的loop循环.  (1)
    - TcpServer内部的threadpool，可以外部设置进去.(4-32)
    - 跟网关交互的Eventloop的线程. (2-4)
    - 三方认证线程池,，可以外部设置进去 (4-32)

7. 全局资源归纳
    - 目标交易网关地址信息
    - TcpServer的eventloop
    - 转发目标网关的eventloop
    - 客户连接信息跟connid 的关联

8. 用户断开的处理
    - 客户端主动断开，则需要srcConn 通知 dstClient 关闭
    - 网关主动断开，则需要dstClinet 通知 SrcConn关闭
    






## 数据流
1. 接受到客户端请求
2. 根据连接id找到对应线程id，然后是对应线程函数，



